# 本地开发环境

<cite>
**本文档引用的文件**   
- [pyproject.toml](file://pyproject.toml)
- [README.md](file://README.md)
- [src/acemcp/server.py](file://src/acemcp/server.py)
- [src/acemcp/config.py](file://src/acemcp/config.py)
- [src/acemcp/logging_config.py](file://src/acemcp/logging_config.py)
- [src/acemcp/web/app.py](file://src/acemcp/web/app.py)
- [src/acemcp/web/log_handler.py](file://src/acemcp/web/log_handler.py)
- [src/acemcp/tools/search_context.py](file://src/acemcp/tools/search_context.py)
- [src/acemcp/index/manager.py](file://src/acemcp/index/manager.py)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [依赖管理与虚拟环境](#依赖管理与虚拟环境)
3. [开发依赖与代码质量](#开发依赖与代码质量)
4. [服务运行与调试](#服务运行与调试)
5. [日志查看](#日志查看)
6. [常见问题](#常见问题)

## 本地开发环境搭建

本指南为开发者提供详细的本地开发环境搭建步骤。项目使用 `uv` 作为现代 Python 包和虚拟环境管理工具，替代传统的 `pip` 和 `venv`。通过本指南，您将学会如何配置开发环境、安装依赖、运行服务并进行调试。

**Section sources**
- [README.md](file://README.md#L23-L35)
- [pyproject.toml](file://pyproject.toml#L1-L114)

## 依赖管理与虚拟环境

### 使用uv创建虚拟环境

`uv` 是一个快速的 Python 包管理器和虚拟环境管理器。首先，使用 `uv` 创建一个隔离的 Python 虚拟环境：

```bash
uv venv
```

此命令将在项目根目录下创建一个名为 `.venv` 的虚拟环境目录，其中包含独立的 Python 解释器和包安装路径。

### 激活虚拟环境

创建虚拟环境后，需要激活它以使用其中的 Python 和包。根据您的操作系统，执行以下命令之一：

- **macOS/Linux**:
  ```bash
  source .venv/bin/activate
  ```

- **Windows**:
  ```bash
  .venv\Scripts\activate
  ```

激活成功后，您的命令行提示符前会显示 `(.venv)`，表示当前处于虚拟环境中。

### 安装可编辑模式的包

在激活的虚拟环境中，使用 `uv pip` 安装项目本身及其依赖。`-e` 标志表示以“可编辑”模式安装，这意味着您对项目源代码的任何修改都会立即反映在已安装的包中，无需重新安装。

```bash
uv pip install -e .
```

此命令会读取 `pyproject.toml` 文件，安装项目运行所需的所有依赖项（`dependencies` 部分）以及开发工具。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L10-L20)
- [README.md](file://README.md#L30-L31)

## 开发依赖与代码质量

### 依赖分组

`pyproject.toml` 文件使用 `[dependency-groups]` 表达式来组织不同类型的依赖。`dev` 组专门用于存放开发和测试所需的工具。

```toml
[dependency-groups]
dev = [
    "pip>=25.3",
    "pre-commit>=4.3.0",
    "ruff>=0.14.3",
]
```

- `pip`: Python 包安装器，确保使用最新版本。
- `pre-commit`: 一个框架，用于在代码提交前自动运行检查。
- `ruff`: 一个极快的 Python 代码检查和格式化工具，用于替代 `flake8`、`isort` 等。

### 配置pre-commit钩子

`pre-commit` 钩子可以确保在每次提交代码前自动执行代码格式化和静态检查，保证代码库风格的一致性。

1.  **安装pre-commit钩子**:
    在项目根目录下运行以下命令，将 `pre-commit` 钩子安装到本地的 `.git/hooks` 目录中。

    ```bash
    pre-commit install
    ```

2.  **配置文件**:
    `pre-commit` 的配置通常在 `.pre-commit-config.yaml` 文件中定义。虽然此文件未在上下文中提供，但标准配置会包含 `ruff` 作为钩子。

3.  **工作流程**:
    当您执行 `git commit` 时，`pre-commit` 会自动运行。它会：
    - 使用 `ruff` 检查代码风格和潜在错误。
    - 如果发现可自动修复的问题（如导入排序），`ruff` 会自动修复它们。
    - 如果修复后仍有问题，提交将被阻止，并提示您手动修复。

4.  **ruff配置**:
    `ruff` 的具体规则在 `pyproject.toml` 中的 `[tool.ruff]` 部分定义。关键配置包括：
    - `line-length = 336`: 设置代码行的最大长度。
    - `select`: 启用的检查规则集。
    - `ignore`: 忽略的特定规则（例如 `D101` 忽略模块缺少文档字符串）。
    - `isort`: 配置导入排序，确保标准库、第三方库和本地库的导入顺序正确。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L29-L114)

## 服务运行与调试

### 运行服务

项目提供了两种主要方式来启动服务。

#### 方法一：使用acemcp命令

项目通过 `pyproject.toml` 的 `[project.scripts]` 部分定义了一个命令行脚本。

```toml
[project.scripts]
acemcp = "acemcp:run"
```

这会创建一个名为 `acemcp` 的命令。在虚拟环境激活后，您可以直接运行：

```bash
acemcp
```

#### 方法二：直接运行server.py

您也可以直接执行主服务器文件：

```bash
python src/acemcp/server.py
```

### 配置调试器

为了进行断点调试，建议使用支持 Python 调试的 IDE，如 VS Code。

1.  **创建调试配置**:
    在 VS Code 中，创建一个 `.vscode/launch.json` 文件。

2.  **配置示例**:
    ```json
    {
        "version": "0.2.0",
        "configurations": [
            {
                "name": "Debug acemcp",
                "type": "python",
                "request": "launch",
                "program": "src/acemcp/server.py",
                "console": "integratedTerminal",
                "env": {
                    "ACEMCP_BASE_URL": "https://your-api-endpoint.com",
                    "ACEMCP_TOKEN": "your-bearer-token-here"
                },
                "args": ["--web-port", "8888"]
            }
        ]
    }
    ```

3.  **关键参数说明**:
    - `program`: 指向要调试的主程序文件。
    - `env`: 设置环境变量。项目支持 `ACEMCP_` 前缀的环境变量来覆盖配置。
    - `args`: 命令行参数。`--web-port 8888` 用于启动 Web 管理界面。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L22-L23)
- [src/acemcp/server.py](file://src/acemcp/server.py#L117-L136)
- [README.md](file://README.md#L84-L88)

## 日志查看

应用程序使用 `loguru` 库进行日志记录，提供丰富的日志信息。

### 控制台输出

服务运行时，INFO 级别及以上的日志会直接输出到控制台，通常以彩色显示，便于区分。

### 日志文件位置

详细的日志（DEBUG 级别及以上）会被写入日志文件。根据 `config.py` 中的定义，日志文件位于：

```
~/.acemcp/log/acemcp.log
```

- **日志轮转**: 日志文件达到 5MB 时会自动轮转，最多保留 10 个文件。
- **压缩**: 轮转后的日志文件会被压缩为 `.zip` 格式。

### Web管理界面实时日志

如果通过 `--web-port` 参数启动了 Web 管理界面，您可以访问 `http://localhost:8888` 查看实时日志流。该界面通过 WebSocket 连接服务器，提供带自动滚动的实时日志显示。

**Section sources**
- [src/acemcp/logging_config.py](file://src/acemcp/logging_config.py#L30-L32)
- [src/acemcp/config.py](file://src/acemcp/config.py#L80-L84)
- [README.md](file://README.md#L297-L312)

## 常见问题

### Python版本不兼容

**问题**: 项目要求 Python 3.10 或更高版本。

**解决方案**: 检查您的 Python 版本。
```bash
python --version
```
如果版本过低，请升级到 Python 3.10+。

### 依赖安装失败

**问题**: `uv pip install -e .` 命令失败。

**解决方案**:
1.  确保虚拟环境已正确激活。
2.  尝试更新 `uv` 工具本身。
3.  检查网络连接，或尝试使用国内镜像源（如果 `uv` 支持配置）。

### 无法启动服务

**问题**: 运行 `acemcp` 或 `python src/acemcp/server.py` 时出错。

**解决方案**:
1.  检查 `~/.acemcp/settings.toml` 配置文件是否存在且配置正确，特别是 `BASE_URL` 和 `TOKEN`。
2.  查看 `~/.acemcp/log/acemcp.log` 日志文件以获取详细的错误信息。
3.  确保所有依赖已正确安装。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L9)
- [src/acemcp/config.py](file://src/acemcp/config.py#L152-L165)
- [src/acemcp/logging_config.py](file://src/acemcp/logging_config.py#L30-L32)