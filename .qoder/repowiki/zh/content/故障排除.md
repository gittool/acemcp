# 故障排除

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [config.py](file://src/acemcp/config.py)
- [logging_config.py](file://src/acemcp/logging_config.py)
- [server.py](file://src/acemcp/server.py)
- [web/app.py](file://src/acemcp/web/app.py)
- [index/manager.py](file://src/acemcp/index/manager.py)
- [tools/search_context.py](file://src/acemcp/tools/search_context.py)
</cite>

## 目录
1. [索引失败](#索引失败)
2. [搜索无结果](#搜索无结果)
3. [Web界面无法访问](#web界面无法访问)
4. [MCP工具调用超时](#mcp工具调用超时)
5. [常见错误信息解释](#常见错误信息解释)
6. [调试技巧](#调试技巧)
7. [性能问题排查](#性能问题排查)

## 索引失败

索引失败可能由编码检测错误或权限问题引起。系统在索引过程中会自动处理多种编码格式（UTF-8、GBK、GB2312、Latin-1），并在失败时回退到UTF-8错误处理模式。如果文件无法以任何支持的编码读取，将记录错误日志并跳过该文件。

权限问题通常发生在尝试访问受保护的系统目录或文件时。确保MCP服务器对目标项目目录具有读取权限。此外，`.gitignore`文件中的模式和配置的排除模式（如`node_modules`、`.venv`等）也会导致文件被自动跳过。

**诊断步骤：**
1. 检查日志输出，确认是否存在编码或权限相关的错误信息。
2. 验证项目根路径是否存在且可访问。
3. 确认配置中的`exclude_patterns`和`.gitignore`模式是否正确。

**解决方案：**
- 确保项目路径正确且服务器有读取权限。
- 检查并调整`exclude_patterns`配置以包含或排除特定文件类型。
- 使用工具调试器测试`search_context`工具，验证索引过程。

**中文错误示例：**
- “Failed to read file with any encoding” → “无法以任何编码读取文件”
- “Project root path does not exist” → “项目根路径不存在”

**Section sources**
- [index/manager.py](file://src/acemcp/index/manager.py#L14-L47)
- [index/manager.py](file://src/acemcp/index/manager.py#L273-L328)
- [config.py](file://src/acemcp/config.py#L45-L77)

## 搜索无结果

当搜索返回空结果时，可能是由于索引未完成、查询关键词不匹配或项目中无相关代码上下文。系统在执行搜索前会自动进行增量索引，确保结果始终是最新的。如果索引完成后仍无结果，说明在代码库中未找到与查询语义相关的代码片段。

**诊断步骤：**
1. 检查日志输出，确认索引是否成功完成。
2. 验证查询关键词是否准确，尝试使用更通用的搜索词。
3. 确认项目路径和查询参数是否正确传递给`search_context`工具。

**解决方案：**
- 使用Web界面的工具调试器测试`search_context`工具，输入项目路径和查询。
- 查看格式化的结果和错误消息，确认是否有索引或搜索失败的提示。
- 确保查询关键词与代码中的注释或变量名匹配。

**中文错误示例：**
- “No relevant code context found for your query” → “未找到与您的查询相关的代码上下文”

**Section sources**
- [tools/search_context.py](file://src/acemcp/tools/search_context.py#L10-L49)
- [index/manager.py](file://src/acemcp/index/manager.py#L467-L549)

## Web界面无法访问

Web管理界面无法访问可能由端口冲突、配置错误或服务器未启动Web服务引起。要启用Web界面，必须在启动MCP服务器时添加`--web-port`参数，并指定可用端口。

**诊断步骤：**
1. 确认是否在启动命令中添加了`--web-port`参数。
2. 检查指定端口是否已被其他进程占用。
3. 查看日志输出，确认Web服务器是否成功启动。

**解决方案：**
- 在启动命令中添加`--web-port`参数，例如`--web-port 8888`。
- 更改端口号以避免冲突。
- 访问`http://localhost:{port}`查看管理界面。

**中文错误示例：**
- “Failed to load projects” → “加载项目失败”
- “WebSocket client disconnected” → “WebSocket客户端已断开连接”

**Section sources**
- [server.py](file://src/acemcp/server.py#L117-L135)
- [web/app.py](file://src/acemcp/web/app.py#L39-L188)
- [README.md](file://README.md#L84-L125)

## MCP工具调用超时

MCP工具调用超时通常由网络延迟、API响应慢或服务器负载过高引起。系统为搜索请求设置了60秒的超时限制，并在失败后自动重试最多3次，采用指数退避策略（2秒、4秒、8秒）。

**诊断步骤：**
1. 检查网络连接是否稳定。
2. 查看API端点`{base_url}/agents/codebase-retrieval`是否响应正常。
3. 确认`BASE_URL`和`TOKEN`配置是否正确。

**解决方案：**
- 确保网络连接正常，尝试ping API服务器。
- 验证`BASE_URL`和`TOKEN`配置项是否正确。
- 增加超时时间或调整重试策略（需修改源码）。

**中文错误示例：**
- “Search request failed after retries” → “搜索请求在重试后失败”
- “Request failed after max retries” → “请求在最大重试次数后失败”

**Section sources**
- [index/manager.py](file://src/acemcp/index/manager.py#L127-L161)
- [index/manager.py](file://src/acemcp/index/manager.py#L522-L537)

## 常见错误信息解释

### HTTP 401认证失败
HTTP 401错误表示认证失败，通常是由于`TOKEN`配置错误或缺失。系统使用Bearer Token进行认证，必须确保`TOKEN`值正确且与API服务器匹配。

**解决方案：**
- 检查`settings.toml`文件中的`TOKEN`配置。
- 通过Web界面的配置管理功能更新`TOKEN`。

### 文件读取异常
文件读取异常可能由权限不足、文件损坏或编码不支持引起。系统会尝试多种编码格式读取文件，并在失败时记录警告日志。

**解决方案：**
- 确保服务器对文件具有读取权限。
- 检查文件是否损坏或为空。
- 手动验证文件编码格式。

**Section sources**
- [config.py](file://src/acemcp/config.py#L152-L165)
- [index/manager.py](file://src/acemcp/index/manager.py#L14-L47)

## 调试技巧

### 启用详细日志
系统默认记录DEBUG级别及以上的日志到文件（`~/.acemcp/log/acemcp.log`），并自动轮转。可通过查看日志文件获取详细的执行信息。

**操作步骤：**
1. 打开日志文件`~/.acemcp/log/acemcp.log`。
2. 搜索相关错误信息或调试日志。

### 使用工具调试器测试search_context
Web界面提供工具调试器，可直接测试`search_context`工具。

**操作步骤：**
1. 访问Web管理界面。
2. 进入“工具调试器”部分。
3. 输入项目路径和查询，点击执行。
4. 查看格式化的结果和错误消息。

**Section sources**
- [web/app.py](file://src/acemcp/web/app.py#L139-L167)
- [logging_config.py](file://src/acemcp/logging_config.py#L14-L67)

## 性能问题排查

### 索引速度慢
索引速度慢可能由大文件、网络延迟或批量大小配置不当引起。系统会自动分割大文件（默认每块800行），并按批次上传。

**排查方法：**
1. 检查是否存在大文件导致分割过多。
2. 验证`batch_size`配置是否合理。
3. 查看网络延迟是否影响上传速度。

### 搜索延迟高
搜索延迟高通常由API响应慢或索引数据量大引起。

**排查方法：**
1. 检查API端点响应时间。
2. 确认索引数据量是否过大。
3. 验证`max_lines_per_blob`配置是否合理。

**性能优化建议：**
- 调整`batch_size`和`max_lines_per_blob`配置以适应项目规模。
- 确保网络连接稳定。
- 定期清理不必要的索引数据。

**Section sources**
- [index/manager.py](file://src/acemcp/index/manager.py#L70-L90)
- [config.py](file://src/acemcp/config.py#L10-L44)