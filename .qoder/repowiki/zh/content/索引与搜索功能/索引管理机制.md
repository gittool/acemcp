# 索引管理机制

<cite>
**本文档引用的文件**
- [manager.py](file://src/acemcp/index/manager.py)
- [config.py](file://src/acemcp/config.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [文件收集机制](#文件收集机制)
4. [大文件分块处理](#大文件分块处理)
5. [增量索引更新](#增量索引更新)
6. [状态持久化](#状态持久化)
7. [批量上传与重试机制](#批量上传与重试机制)
8. [配置参数详解](#配置参数详解)
9. [使用示例](#使用示例)

## 简介
索引管理机制是代码库索引系统的核心组件，负责管理代码库的索引和检索过程。该机制通过`IndexManager`类实现，提供了文件收集、增量索引更新和大文件分块处理等关键功能。系统能够智能地识别文件变更，仅上传修改过的文件块，从而提高索引效率并减少网络传输开销。

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L67-L552)

## 核心组件
`IndexManager`类是索引管理机制的核心，封装了代码库索引和检索的所有功能。该类通过构造函数接收多个配置参数，包括存储路径、基础URL、认证令牌、文本文件扩展名等。系统实现了自动化的文件收集、内容分块、增量更新和状态持久化等功能，确保代码库索引的准确性和时效性。

```mermaid
classDiagram
class IndexManager {
+storage_path Path
+base_url str
+token str
+text_extensions set[str]
+batch_size int
+max_lines_per_blob int
+exclude_patterns list[str]
+projects_file Path
+__init__(storage_path, base_url, token, text_extensions, batch_size, max_lines_per_blob, exclude_patterns) void
+_normalize_path(path) str
+_load_gitignore(root_path) PathSpec | None
+_retry_request(func, max_retries, retry_delay, *args, **kwargs) Any
+_should_exclude(path, root_path, gitignore_spec) bool
+_load_projects() dict[str, list[str]]
+_save_projects(projects) None
+_split_file_content(path, content) list[dict[str, str]]
+_collect_files(project_root_path) list[dict[str, str]]
+index_project(project_root_path) dict[str, str]
+search_context(project_root_path, query) str
}
class Config {
+index_storage_path Path
+batch_size int
+max_lines_per_blob int
+base_url str
+token str
+text_extensions set[str]
+exclude_patterns list[str]
+__init__(base_url, token) None
+reload() None
+validate() None
}
IndexManager --> Config : "使用"
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L67-L552)
- [config.py](file://src/acemcp/config.py#L119-L200)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L67-L552)

## 文件收集机制
文件收集机制通过`_collect_files`方法实现，负责遍历项目目录并收集所有文本文件。该机制结合了`.gitignore`规则和自定义排除模式，确保只索引相关的代码文件。系统使用`pathspec`库解析`.gitignore`文件，实现了与Git相同的文件排除逻辑。

```mermaid
flowchart TD
Start([开始文件收集]) --> CheckExistence["检查项目根路径是否存在"]
CheckExistence --> |不存在| ThrowError["抛出FileNotFoundError"]
CheckExistence --> |存在| LoadGitignore["加载.gitignore文件"]
LoadGitignore --> ParseGitignore["解析.gitignore规则"]
ParseGitignore --> WalkDirectory["遍历目录结构"]
WalkDirectory --> FilterDirectories["过滤排除的目录"]
FilterDirectories --> ProcessFiles["处理文件"]
ProcessFiles --> CheckExclusion["检查文件是否应被排除"]
CheckExclusion --> |是| SkipFile["跳过文件"]
CheckExclusion --> |否| CheckExtension["检查文件扩展名"]
CheckExtension --> |不匹配| SkipFile
CheckExtension --> |匹配| ReadFile["读取文件内容"]
ReadFile --> SplitContent["检查是否需要分块"]
SplitContent --> |需要| SplitFile["分块处理"]
SplitContent --> |不需要| AddBlob["添加到blobs列表"]
SplitFile --> AddBlobs["添加多个blob到列表"]
AddBlob --> Continue["继续处理下一个文件"]
AddBlobs --> Continue
Continue --> MoreFiles{"还有更多文件?"}
MoreFiles --> |是| ProcessFiles
MoreFiles --> |否| ReturnBlobs["返回收集的blobs列表"]
SkipFile --> Continue
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L274-L329)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L274-L329)

## 大文件分块处理
大文件分块处理机制通过`_split_file_content`方法实现，当文件行数超过`max_lines_per_blob`限制时，将文件内容分割成多个块。这种分块策略确保了单个文件块的大小在可管理范围内，提高了索引和检索的效率。

```mermaid
flowchart TD
Start([开始分块处理]) --> CountLines["计算文件总行数"]
CountLines --> CheckLimit["检查行数是否超过限制"]
CheckLimit --> |未超过| SingleBlob["作为单个blob返回"]
CheckLimit --> |超过| CalculateChunks["计算分块数量"]
CalculateChunks --> InitializeBlobs["初始化blobs列表"]
InitializeBlobs --> LoopChunks["循环处理每个块"]
LoopChunks --> DetermineRange["确定当前块的行范围"]
DetermineRange --> ExtractContent["提取块内容"]
ExtractContent --> CreatePath["创建分块路径"]
CreatePath --> AddBlob["添加blob到列表"]
AddBlob --> NextChunk{"是否还有更多块?"}
NextChunk --> |是| LoopChunks
NextChunk --> |否| LogSplit["记录分块信息"]
LogSplit --> ReturnBlobs["返回分块列表"]
SingleBlob --> ReturnBlobs
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L240-L272)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L240-L272)

## 增量索引更新
增量索引更新机制是`index_project`方法的核心功能，通过SHA-256哈希值识别新旧文件，仅上传变更的文件块。该机制显著提高了索引效率，避免了重复上传未修改的文件内容。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant IndexManager as "IndexManager"
participant API as "API服务器"
Client->>IndexManager : 调用index_project()
IndexManager->>IndexManager : _collect_files()收集文件
IndexManager->>IndexManager : _load_projects()加载现有项目
IndexManager->>IndexManager : 计算所有blob的SHA-256哈希
IndexManager->>IndexManager : 比较新旧哈希值
IndexManager->>IndexManager : 分离出需要上传的新blobs
IndexManager->>IndexManager : 按批次上传新blobs
loop 每个批次
IndexManager->>API : 发送batch-upload请求
API-->>IndexManager : 返回blob_names
IndexManager->>IndexManager : 处理上传结果
end
IndexManager->>IndexManager : 合并现有和新上传的blob_names
IndexManager->>IndexManager : _save_projects()保存项目状态
IndexManager-->>Client : 返回索引结果
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L331-L466)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L331-L466)

## 状态持久化
状态持久化机制通过`projects.json`文件实现，用于存储项目的索引状态。该文件记录了每个项目路径对应的blob名称列表，支持增量索引和状态恢复。

```mermaid
erDiagram
PROJECTS_JSON {
string project_root_path PK
array blob_names
}
PROJECTS_JSON ||--o{ BLOB : "包含"
BLOB {
string blob_name PK
string path
string content
string hash
}
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L212-L238)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L212-L238)

## 批量上传与重试机制
批量上传与重试机制确保了索引过程的可靠性和容错性。系统采用指数退避策略进行请求重试，能够有效应对网络波动和临时性故障。

```mermaid
flowchart TD
Start([开始上传批次]) --> ExecuteUpload["执行上传请求"]
ExecuteUpload --> CheckSuccess{"上传成功?"}
CheckSuccess --> |是| ReturnResult["返回结果"]
CheckSuccess --> |否| CheckErrorType{"错误类型可重试?"}
CheckErrorType --> |否| RaiseError["立即抛出异常"]
CheckErrorType --> |是| CheckAttempts{"达到最大重试次数?"}
CheckAttempts --> |是| LogError["记录最终错误"]
CheckAttempts --> |否| CalculateWait["计算等待时间"]
CalculateWait --> Wait["等待指定时间"]
Wait --> Retry["重试上传"]
Retry --> ExecuteUpload
LogError --> ReturnError["返回错误结果"]
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L128-L162)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L128-L162)

## 配置参数详解
`IndexManager`类的构造函数接受多个配置参数，每个参数都有特定的作用和配置方式：

| 参数名称 | 类型 | 默认值 | 作用说明 |
|--------|-----|-------|--------|
| storage_path | Path | 无 | 存储索引数据的路径，系统会自动创建该目录 |
| base_url | str | 无 | API请求的基础URL，用于与远程服务器通信 |
| token | str | 无 | 授权令牌，用于API请求的身份验证 |
| text_extensions | set[str] | 无 | 要索引的文本文件扩展名集合 |
| batch_size | int | 无 | 每批上传的文件数量，控制批量上传的大小 |
| max_lines_per_blob | int | 800 | 单个blob的最大行数，超过此值将进行分块 |
| exclude_patterns | list[str] | None | 要排除的文件和目录模式列表 |

这些参数通过`Config`类从配置文件和环境变量中加载，支持灵活的配置管理。

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L70-L91)
- [config.py](file://src/acemcp/config.py#L122-L150)

## 使用示例
以下是`IndexManager`的初始化和调用流程示例：

```mermaid
flowchart TD
Start([程序启动]) --> CreateConfig["创建Config实例"]
CreateConfig --> InitIndexManager["初始化IndexManager"]
InitIndexManager --> CallIndexProject["调用index_project()"]
CallIndexProject --> AutoIndexing["自动执行增量索引"]
AutoIndexing --> CollectFiles["收集项目文件"]
CollectFiles --> SplitLargeFiles["分块处理大文件"]
SplitLargeFiles --> CompareHashes["比较文件哈希值"]
CompareHashes --> UploadNewFiles["上传新文件块"]
UploadNewFiles --> UpdateStatus["更新projects.json"]
UpdateStatus --> ReturnResult["返回索引结果"]
CallIndexProject --> UseResult["使用索引结果"]
UseResult --> End([流程结束])
```

**Diagram sources**
- [manager.py](file://src/acemcp/index/manager.py#L331-L466)

**Section sources**
- [manager.py](file://src/acemcp/index/manager.py#L331-L466)