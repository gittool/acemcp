# 部署与集成

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [config.py](file://src/acemcp/config.py)
- [server.py](file://src/acemcp/server.py)
- [app.py](file://src/acemcp/web/app.py)
- [pyproject.toml](file://pyproject.toml)
</cite>

## 目录
1. [简介](#简介)
2. [部署方式](#部署方式)
3. [服务启动方式](#服务启动方式)
4. [端口配置与网络访问](#端口配置与网络访问)
5. [与MCP客户端集成](#与mcp客户端集成)
6. [外部API服务集成](#外部api服务集成)
7. [Docker化部署建议](#docker化部署建议)
8. [高可用性与安全加固](#高可用性与安全加固)

## 简介
acemcp是一个用于代码库索引和语义搜索的MCP服务器，支持多编码文件和.gitignore集成。本指南详细说明了在生产或开发环境中部署acemcp服务的方法，包括服务启动、端口配置、与MCP客户端（如Claude Desktop）的集成，以及与外部API服务的连接配置。

## 部署方式

acemcp提供多种安装和部署方式，用户可根据需求选择最适合的方案。

### 工具安装（推荐）
推荐使用`uv`工具进行安装，这种方式简单快捷，无需手动管理依赖。

```bash
# 安装到系统
uv tool install acemcp

# 或临时运行（无需安装）
uvx acemcp
```

### 开发安装
对于开发者，可以通过克隆仓库进行开发安装。

```bash
# 克隆仓库
git clone https://github.com/qy527145/acemcp.git
cd acemcp

# 安装依赖
uv sync

# 运行
uv run acemcp
```

**Section sources**
- [README.md](file://README.md#L11-L35)

## 服务启动方式

acemcp服务可以通过MCP客户端自动启动，也可以手动运行。

### 自动启动（由MCP客户端启动）
当在MCP客户端（如Claude Desktop）中配置acemcp后，客户端会自动启动服务。这是最常用的启动方式。

### 手动运行
用户也可以通过命令行手动启动服务，支持多种参数配置。

```bash
# 基本启动
uvx acemcp

# 覆盖配置启动
uvx acemcp --base-url https://your-api-endpoint.com --token your-bearer-token

# 启用Web管理界面
uvx acemcp --web-port 8888
```

服务启动时会自动创建配置文件`~/.acemcp/settings.toml`，包含默认配置值。

**Section sources**
- [README.md](file://README.md#L33-L35)
- [server.py](file://src/acemcp/server.py#L117-L139)

## 端口配置与网络访问

### Web管理界面端口
通过`--web-port`参数可以启用Web管理界面，指定监听端口。

```json
{
  "mcpServers": {
    "acemcp": {
      "command": "uvx",
      "args": [
        "acemcp",
        "--web-port",
        "8888"
      ]
    }
  }
}
```

启动后可通过`http://localhost:8888`访问管理界面。

### 网络访问设置
Web服务器默认监听`0.0.0.0`，允许外部访问。生产环境中建议通过防火墙或反向代理限制访问。

```python
# src/acemcp/server.py中的配置
config_uvicorn = uvicorn.Config(
    web_app,
    host="0.0.0.0",  # 监听所有网络接口
    port=port,
    log_level="warning",
    access_log=False
)
```

**Section sources**
- [README.md](file://README.md#L84-L108)
- [server.py](file://src/acemcp/server.py#L76-L82)

## 与MCP客户端集成

### MCP客户端配置
将以下配置添加到MCP客户端配置文件中（如Claude Desktop）。

#### 基础配置
```json
{
  "mcpServers": {
    "acemcp": {
      "command": "uvx",
      "args": [
        "acemcp"
      ]
    }
  }
}
```

#### 启用Web管理界面的配置
```json
{
  "mcpServers": {
    "acemcp": {
      "command": "uvx",
      "args": [
        "acemcp",
        "--web-port",
        "8888"
      ]
    }
  }
}
```

### Web管理功能
启用Web管理界面后，可通过浏览器访问`http://localhost:8888`，获得以下功能：

- **配置管理**：查看和编辑服务器配置（BASE_URL、TOKEN、BATCH_SIZE、MAX_LINES_PER_BLOB、TEXT_EXTENSIONS）
- **实时日志**：通过WebSocket连接实时监控服务器日志，具有智能重连功能
  - 指数退避重连策略（1秒 → 1.5秒 → 2.25秒 ... 最大30秒）
  - 最多10次重连尝试，防止无限循环
  - 网络故障时自动重连
  - 减少日志噪音（WebSocket连接记录在DEBUG级别）
- **工具调试器**：直接从Web界面测试和调试MCP工具
  - 测试`search_context`工具，输入项目路径和查询
  - 查看格式化的结果和错误消息

**Section sources**
- [README.md](file://README.md#L64-L125)
- [app.py](file://src/acemcp/web/app.py#L39-L188)

## 外部API服务集成

### base_url和token配置
acemcp通过`base_url`和`token`配置连接不同的后端API服务。

#### 配置方式
1. **配置文件**：编辑`~/.acemcp/settings.toml`
```toml
BASE_URL = "https://your-api-endpoint.com"
TOKEN = "your-bearer-token-here"
```

2. **命令行参数**（最高优先级）
```bash
uvx acemcp --base-url https://your-api-endpoint.com --token your-bearer-token
```

3. **环境变量**
```bash
export ACEMCP_BASE_URL="https://your-api-endpoint.com"
export ACEMCP_TOKEN="your-bearer-token"
```

4. **Web管理界面**：通过Web界面直接修改配置

#### 配置选项
- `BATCH_SIZE`：每批上传的文件数量（默认：10）
- `MAX_LINES_PER_BLOB`：大文件分割前的最大行数（默认：800）
- `BASE_URL`：API端点URL
- `TOKEN`：认证令牌
- `TEXT_EXTENSIONS`：要索引的文件扩展名列表
- `EXCLUDE_PATTERNS`：要排除的模式列表（支持通配符如`*.pyc`）

**Section sources**
- [README.md](file://README.md#L37-L62)
- [config.py](file://src/acemcp/config.py#L121-L150)

## Docker化部署建议

虽然项目未提供官方Docker镜像，但可以根据以下建议创建Docker化部署。

### Dockerfile示例
```dockerfile
FROM python:3.10-slim

WORKDIR /app

# 安装uv
RUN pip install uv

# 复制项目文件
COPY pyproject.toml uv.lock ./
COPY src/ src/

# 安装依赖
RUN uv sync

# 创建配置目录
RUN mkdir -p /root/.acemcp

# 暴露Web管理界面端口
EXPOSE 8888

# 启动命令
CMD ["uvx", "acemcp", "--web-port", "8888"]
```

### docker-compose.yml示例
```yaml
version: '3'
services:
  acemcp:
    build: .
    ports:
      - "8888:8888"
    environment:
      - ACEMCP_BASE_URL=https://your-api-endpoint.com
      - ACEMCP_TOKEN=your-bearer-token
    volumes:
      - acemcp_config:/root/.acemcp

volumes:
  acemcp_config:
```

**Section sources**
- [pyproject.toml](file://pyproject.toml#L1-L27)
- [config.py](file://src/acemcp/config.py#L80-L84)

## 高可用性与安全加固

### 高可用性部署
1. **多实例部署**：在不同服务器上部署多个acemcp实例，通过负载均衡分发请求。
2. **健康检查**：通过Web管理界面的`/api/status`端点进行健康检查。
3. **配置持久化**：将`~/.acemcp`目录挂载为持久化存储，确保配置和索引数据不丢失。

### 安全加固
1. **令牌保护**：确保TOKEN的机密性，避免硬编码在代码中。
2. **网络隔离**：限制Web管理界面的访问IP范围。
3. **日志安全**：定期轮转和归档日志文件，避免敏感信息泄露。
4. **输入验证**：服务已内置配置验证，确保BATCH_SIZE和MAX_LINES_PER_BLOB为正数，BASE_URL和TOKEN已配置。

```python
# src/acemcp/config.py中的配置验证
def validate(self) -> None:
    """Validate configuration."""
    if self.batch_size <= 0:
        msg = "BATCH_SIZE must be positive"
        raise ValueError(msg)
    if self.max_lines_per_blob <= 0:
        msg = "MAX_LINES_PER_BLOB must be positive"
        raise ValueError(msg)
    if not self.base_url:
        msg = "BASE_URL must be configured"
        raise ValueError(msg)
    if not self.token:
        msg = "TOKEN must be configured"
        raise ValueError(msg)
```

**Section sources**
- [config.py](file://src/acemcp/config.py#L152-L165)
- [logging_config.py](file://src/acemcp/logging_config.py#L31-L32)